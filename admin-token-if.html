<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>tMegaCarrot Admin Tool</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial; max-width: 600px; margin: 2rem auto; }
    input, textarea, button, select { width: 100%; margin: 0.5rem 0; padding: 0.5rem; }
    .hidden { display: none; }
    pre { background: #f0f0f0; padding: 1rem; border-radius: 8px; }
  </style>
</head>
<body>
  <h2>ğŸ° tMegaCarrot Admin Tool</h2>
  <p id="status">ğŸŸ¡ ì§€ê°‘ì„ ì—°ê²°í•˜ì„¸ìš”...</p>

  <button id="connectButton">ğŸ”— ë©”íƒ€ë§ˆìŠ¤í¬ ì—°ê²°</button>

  <div id="adminPanel" class="hidden">
    <hr/>
    <h3>1. ì…€í”„ ë¯¼íŒ…</h3>
    <input type="number" id="selfAmount" placeholder="ë¯¼íŒ…í•  ìˆ˜ëŸ‰ ì…ë ¥" />
    <button id="selfMintBtn">ğŸª™ ì…€í”„ ë¯¼íŒ…</button>

    <hr/>
    <h3>2. ë°°ì¹˜ ë¯¼íŒ…</h3>
    <textarea id="batchInput" rows="8" placeholder="ì£¼ì†Œ,ìˆ˜ëŸ‰ í˜•ì‹ìœ¼ë¡œ í•œ ì¤„ì”© ì…ë ¥"></textarea>
    <button id="batchMintBtn">ğŸ“¤ ë°°ì¹˜ ë¯¼íŒ…</button>

    <hr/>
    <h3>3. ê´€ë¦¬ì ì£¼ì†Œ ì¶”ê°€/ì œê±°</h3>
    <input type="text" id="adminAddress" placeholder="ì§€ì •í•  ì£¼ì†Œ ì…ë ¥" />
    <select id="adminStatus">
      <option value="true">âœ” ê´€ë¦¬ì ì¶”ê°€</option>
      <option value="false">âœ– ê´€ë¦¬ì ì œê±°</option>
    </select>
    <button id="setAdminBtn">ğŸ”§ setAdmin ì‹¤í–‰</button>

    <hr/>
    <h3>4. ë©”íƒ€ë§ˆìŠ¤í¬ì— í† í° ì¶”ê°€</h3>
    <button id="addTokenBtn">â• ë©”íƒ€ë§ˆìŠ¤í¬ì— tCarrot ì¶”ê°€</button>

    <hr/>
    <h3>5. tCarrot ì „ì†¡</h3>
    <p id="balanceInfo">ì”ê³  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    <input type="text" id="transferTo" placeholder="ë°›ëŠ” ì£¼ì†Œ ì…ë ¥" />
    <input type="number" id="transferAmount" placeholder="ë³´ë‚¼ ìˆ˜ëŸ‰ ì…ë ¥ (ì˜ˆ: 100)" />
    <button id="transferBtn">ğŸ“¤ tCarrot ì „ì†¡</button>

    <hr/>
    <pre id="log" style="white-space: pre-wrap;"></pre>
  </div>

  <script>
    const contractAddress = "0xFf10BAfc4e97db549438d67b4f1851bC5E548b9A";
    const contractABI = [
      "function mint(address to, uint256 amount) external",
      "function isAdmin(address) view returns (bool)",
      "function setAdmin(address user, bool status) external",
      "function transfer(address to, uint256 amount) external returns (bool)",
      "function balanceOf(address account) view returns (uint256)"
    ];

    let provider, signer, contract;

    async function connectWallet() {
      if (typeof window.ethereum === 'undefined') {
        alert("âŒ ë©”íƒ€ë§ˆìŠ¤í¬ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.");
        return;
      }

      try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        const userAddress = await signer.getAddress();
        contract = new ethers.Contract(contractAddress, contractABI, signer);

        const isAdmin = await contract.isAdmin(userAddress);
        document.getElementById("status").innerText = `ğŸŸ¢ ì—°ê²°ë¨: ${userAddress}`;
        if (isAdmin) {
          document.getElementById("adminPanel").classList.remove("hidden");
        } else {
          document.getElementById("status").innerText += "\nâŒ ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.";
        }

        await loadBalances();
      } catch (err) {
        alert("âŒ ì§€ê°‘ ì—°ê²° ì‹¤íŒ¨: " + err.message);
      }
    }

    async function loadBalances() {
      try {
        const userAddress = await signer.getAddress();
        const native = await provider.getBalance(userAddress);
        const nativeFormatted = ethers.utils.formatEther(native);
        const token = await contract.balanceOf(userAddress);
        const tokenFormatted = ethers.utils.formatUnits(token, 18);
        document.getElementById("balanceInfo").innerText =
          `ğŸ’° ì”ê³ : ${tokenFormatted} tCarrot | ${nativeFormatted} ETH`;
      } catch (err) {
        document.getElementById("balanceInfo").innerText = "âŒ ì”ê³  ì¡°íšŒ ì‹¤íŒ¨";
      }
    }

    async function selfMint() {
      const amount = document.getElementById("selfAmount").value;
      if (!amount || isNaN(amount) || amount <= 0) return alert("ìœ íš¨í•œ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”");
      const userAddress = await signer.getAddress();
      try {
        const tx = await contract.mint(userAddress, ethers.utils.parseUnits(amount, 18));
        log(`â³ ì…€í”„ë¯¼íŒ… ì¤‘: ${tx.hash}`);
        await tx.wait();
        log(`âœ… ì™„ë£Œ: ${tx.hash}`);
        await loadBalances();
      } catch (err) {
        log(`âŒ ì˜¤ë¥˜: ${err.message}`);
      }
    }

    async function batchMint() {
      const input = document.getElementById("batchInput").value.trim();
      const lines = input.split("\n").map(l => l.trim()).filter(Boolean);
      for (const line of lines) {
        const [addr, amount] = line.split(",").map(s => s.trim());
        if (!ethers.utils.isAddress(addr) || isNaN(amount) || amount <= 0) {
          log(`âŒ ë¬´ì‹œë¨: ${line}`);
          continue;
        }
        try {
          const tx = await contract.mint(addr, ethers.utils.parseUnits(amount, 18));
          log(`â³ ${addr}ì—ê²Œ ${amount} í† í° ë¯¼íŒ… ì¤‘: ${tx.hash}`);
          await tx.wait();
          log(`âœ… ì™„ë£Œ: ${tx.hash}`);
        } catch (err) {
          log(`âŒ ì‹¤íŒ¨ (${addr}): ${err.message}`);
        }
      }
    }

    async function setAdmin() {
      const addr = document.getElementById("adminAddress").value.trim();
      const status = document.getElementById("adminStatus").value === "true";
      if (!ethers.utils.isAddress(addr)) {
        alert("ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë”ë¦¬ì›€ ì£¼ì†Œì…ë‹ˆë‹¤.");
        return;
      }
      try {
        const tx = await contract.setAdmin(addr, status);
        log(`â³ setAdmin(${addr}, ${status}) ì‹¤í–‰ ì¤‘: ${tx.hash}`);
        await tx.wait();
        log(`âœ… ê´€ë¦¬ì ì„¤ì • ì™„ë£Œ: ${addr} (${status})`);
      } catch (err) {
        log(`âŒ ê´€ë¦¬ì ì„¤ì • ì‹¤íŒ¨: ${err.message}`);
      }
    }

    async function addTokenToMetaMask() {
      const tokenImage = "https://i.imgur.com/lrSZcEf.png"; // ì›í•˜ëŠ” ì´ë¯¸ì§€ë¡œ êµì²´ ê°€ëŠ¥
      try {
        const wasAdded = await window.ethereum.request({
          method: 'wallet_watchAsset',
          params: {
            type: 'ERC20',
            options: {
              address: contractAddress,
              symbol: "tCarrot",
              decimals: 18,
              image: tokenImage,
            },
          },
        });
        if (wasAdded) {
          log(`âœ… tCarrot í† í°ì´ ë©”íƒ€ë§ˆìŠ¤í¬ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } else {
          log(`â„¹ï¸ ì‚¬ìš©ìê°€ í† í° ì¶”ê°€ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.`);
        }
      } catch (error) {
        log(`âŒ í† í° ì¶”ê°€ ì‹¤íŒ¨: ${error.message}`);
      }
    }

    async function transferToken() {
      const to = document.getElementById("transferTo").value.trim();
      const amount = document.getElementById("transferAmount").value.trim();
      if (!ethers.utils.isAddress(to)) return alert("ìœ íš¨í•œ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      if (!amount || isNaN(amount) || Number(amount) <= 0) return alert("ìˆ˜ëŸ‰ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.");
      try {
        const tx = await contract.transfer(to, ethers.utils.parseUnits(amount, 18));
        log(`â³ ì „ì†¡ ì¤‘... ${tx.hash}`);
        await tx.wait();
        log(`âœ… ì „ì†¡ ì™„ë£Œ: ${tx.hash}`);
        await loadBalances();
      } catch (err) {
        log(`âŒ ì „ì†¡ ì‹¤íŒ¨: ${err.message}`);
      }
    }

    function log(msg) {
      const logBox = document.getElementById("log");
      logBox.textContent += msg + "\n";
      logBox.scrollTop = logBox.scrollHeight;
    }

    // ì´ë²¤íŠ¸ ì—°ê²°
    document.getElementById("connectButton").onclick = connectWallet;
    document.getElementById("selfMintBtn").onclick = selfMint;
    document.getElementById("batchMintBtn").onclick = batchMint;
    document.getElementById("setAdminBtn").onclick = setAdmin;
    document.getElementById("addTokenBtn").onclick = addTokenToMetaMask;
    document.getElementById("transferBtn").onclick = transferToken;
  </script>
</body>
</html>
