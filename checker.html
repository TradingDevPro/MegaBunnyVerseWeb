<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MegaBunnyVerse Genesis Mint Whitelist Checker</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f4f4f9; color: #333;
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; margin: 0;
    }
    .container {
      background: #fff; padding: 2rem; border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,.1);
      text-align: center; width: 90%; max-width: 600px;
    }
    h1 { color: #4a4a4a; margin-bottom: 1.5rem; }
    #addressInput {
      width: calc(100% - 22px); padding: 10px; margin-bottom: 1rem;
      border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;
    }
    #checkButton {
      width: 100%; padding: 12px; background: #007bff; color: #fff;
      border: 0; border-radius: 4px; cursor: pointer;
      font-size: 1rem; font-weight: 700; transition: background-color .3s;
    }
    #checkButton:hover { background: #0056b3; }
    #results {
      margin-top: 1.5rem; text-align: left; background: #f9f9f9;
      padding: 1rem; border-radius: 4px; border: 1px solid #eee;
      min-height: 50px; white-space: pre-wrap; word-wrap: break-word;
    }
    .result-item {
      padding: .5rem 0 1rem; margin-bottom: 1rem; border-bottom: 1px solid #e0e0e0;
    }
    .result-item:last-child { border-bottom: 0; margin-bottom: 0; }
    .result-item.success { color: #28a745; font-weight: 700; }
    .result-item.error { color: #dc3545; font-weight: 700; }
    .total-quantity { margin-top: 1rem; color: #FE1010; font-size: 1.15em; font-weight: 700; }
    .loader {
      border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
      width: 20px; height: 20px; animation: spin 1s linear infinite;
      display: none; margin: 1rem auto 0;
    }
    #bannerImage { width: 100%; height: auto; border-radius: 8px; margin-bottom: 1.5rem; }
    #resultImageContainer { margin-top: 1.5rem; min-height: 300px; display: flex; justify-content: center; align-items: center; }
    #resultImageContainer img { width: 300px; height: 300px; object-fit: contain; border-radius: 8px; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
  </style>
</head>
<body>
  <div class="container">
    <img src="./images/BANNER.jpg" alt="MegaBunnyVerse Banner" id="bannerImage" />
    <h1>MegaBunnyVerse Genesis Mint Whitelist Checker</h1>
    <p style="font-weight: bold; color: #555;">
    Mint date: Will be announced soon.<br>
    Please stay tuned and check our 
    <a href="https://discord.com/invite/ZnHtZtAQRY" target="_blank" style="color: #007bff; text-decoration: none;">Discord</a> /
    <a href="https://x.com/megabunny_" target="_blank" style="color: #007bff; text-decoration: none;">X</a> 
    announcement.
    </p>
    <p>Please enter your wallet address to check your whitelist status.</p>
    <input type="text" id="addressInput" placeholder="Enter your wallet address here (e.g., 0x...)" />
    <button id="checkButton">Check</button>
    <div id="resultImageContainer"></div>
    <div id="loader" class="loader"></div>
    <div id="results">Results will be displayed here.</div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const phases = [
      {
        name: 'PHASE1 - GTD',
        sources: [
          { path: './data/GTD-collab.csv',   message: '[PHASE1] COLLAB GA WINNER!' },
          { path: './data/GTD-preview1.csv', message: '[PHASE1] TESTNET PREVIEW-1 HOLDER!' },
          { path: './data/GTD-og.csv',       message: '[PHASE1] OG MEMBER!' },
          { path: './data/GTD-team.csv',     message: '[PHASE1] TEAM MEMBER!' },
          { path: './data/GTD-community-supporters.csv',     message: '[PHASE1] COMMUNITY SUPPORTERS!' }
          
        ]
      },
      {
        name: 'PHASE2 - FCFS1',
        sources: [
          { path: './data/FCFS1-collab.csv',   message: '[PHASE2] COLLAB GA WINNER!' },
          { path: './data/FCFS1-preview2.csv', message: '[PHASE2] TESTNET PREVIEW-2 HOLDER!' },
          { path: './data/FCFS1-bunnylist.csv', message: '[PHASE2] BUNNYLIST!' }
        ]
      },
      {
        name: 'PHASE3 - FCFS2',
        sources: [
          { path: './data/FCFS2-testnet1fcfs.csv', message: '[PHASE3] TESTNET PREVIEW-1 FCFS PARTICIPANT!' },
          { path: './data/FCFS2-thefluffles.csv', message: '[PHASE3] THE FLUFFLES HOLDER' },
          { path: './data/FCFS2-submitted600.csv', message: '[PHASE3] COMMUNITY SUPPORTERS' }
        ]
      }
    ];

    const checkButton = document.getElementById('checkButton');
    const addressInput = document.getElementById('addressInput');
    const resultsDiv = document.getElementById('results');
    const loader = document.getElementById('loader');
    const resultImageContainer = document.getElementById('resultImageContainer');

    async function logAddressCheck(address, resultsOrQuantities, quantity) {
      const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwEftowOs-6oLyGL5IsgEgs67BY97KokPvPwmLOuT7JfLvQH0GzuaZM2_VT0S5lrkGcag/exec';

      const payload = Array.isArray(resultsOrQuantities)
        ? {
            address,
            timestamp: new Date().toISOString(),
            gtd:   resultsOrQuantities[0] || 0,
            fcfs1: resultsOrQuantities[1] || 0,
            fcfs2: resultsOrQuantities[2] || 0,
            total_quantity: quantity ?? 0
          }
        : {
            address,
            timestamp: new Date().toISOString(),
            gtd_qty:   resultsOrQuantities.gtd   ?? 0,
            fcfs1_qty: resultsOrQuantities.fcfs1 ?? 0,
            fcfs2_qty: resultsOrQuantities.fcfs2 ?? 0,
            total_quantity: quantity ?? (
              (resultsOrQuantities.gtd||0)
              + (resultsOrQuantities.fcfs1||0)
              + (resultsOrQuantities.fcfs2||0)
            )
          };

      try {
        const beaconOk = navigator.sendBeacon?.(
          APPS_SCRIPT_URL,
          new Blob([JSON.stringify(payload)], { type: 'text/plain;charset=UTF-8' })
        );
        if (beaconOk) return;

        await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.error('Failed to log address to Google Sheets:', err);
      }
    }

    checkButton.addEventListener('click', async () => {
      const addressToFind = addressInput.value.trim();

      if (!addressToFind) {
        resultsDiv.innerHTML = '<div class="result-item error">Please enter a wallet address.</div>';
        return;
      }
      if (!/^0x[a-fA-F0-9]{40}$/.test(addressToFind)) {
        resultsDiv.innerHTML = '<div class="result-item error">Invalid wallet address format.</div>';
        return;
      }

      loader.style.display = 'block';
      resultsDiv.innerHTML = '';
      resultImageContainer.innerHTML = '';
      checkButton.disabled = true;

      let found = false;
      const targetAddress = addressToFind.toLowerCase();

      const allSources = phases.flatMap(phase =>
        phase.sources.map(source => ({ ...source, phaseName: phase.name }))
      );

      const promises = allSources.map(async (source) => {
        try {
          const response = await fetch(source.path);
          if (!response.ok) return null;
          const csvData = await response.text();
          const lines = csvData.split(/\r?\n/).filter(line => line.trim() !== '');

          for (const line of lines) {
            const [address, quantity] = line.split(',').map(item => item.trim());
            if (address && address.toLowerCase() === targetAddress) {
              found = true;
              return {
                phaseName: source.phaseName,
                message: source.message,
                quantity: quantity || '0'
              };
            }
          }
        } catch (error) {
          return null;
        }
        return null;
      });

      const checkResults = (await Promise.all(promises)).filter(Boolean);

      const aggregatedResults = checkResults.reduce((acc, result) => {
        const { phaseName, message, quantity } = result;
        if (!acc[phaseName]) acc[phaseName] = { details: [], totalQuantity: 0 };
        acc[phaseName].details.push({ message, quantity });
        acc[phaseName].totalQuantity += parseInt(quantity, 10) || 0;
        return acc;
      }, {});

      const getPhaseQty = (name) => aggregatedResults[name]?.totalQuantity || 0;

      const gtdQty   = getPhaseQty('PHASE1 - GTD');
      const fcfs1Qty = getPhaseQty('PHASE2 - FCFS1');
      const fcfs2Qty = getPhaseQty('PHASE3 - FCFS2');
      const totalQuantity = gtdQty + fcfs1Qty + fcfs2Qty;

      await logAddressCheck(addressToFind, { gtd: gtdQty, fcfs1: fcfs1Qty, fcfs2: fcfs2Qty }, totalQuantity);

      const whitelistedCount = ['PHASE1 - GTD', 'PHASE2 - FCFS1', 'PHASE3 - FCFS2']
        .filter(name => getPhaseQty(name) > 0).length;

      const img = document.createElement('img');
      img.src = `./images/${whitelistedCount >= 3 ? '3.png' : `${whitelistedCount}.png`}`;
      img.alt = `Whitelist result: ${whitelistedCount} tiers`;
      resultImageContainer.appendChild(img);

      if (!found) {
        const notFoundItem = document.createElement('div');
        notFoundItem.classList.add('result-item', 'error');
        notFoundItem.textContent = '❌ This address is not registered in any phase. \nIf you think this is a mistake, please open a discord ticket.';
        resultsDiv.appendChild(notFoundItem);
      } else {
        phases.forEach(phase => {
          const data = aggregatedResults[phase.name];
          if (!data) return;

          const resultItem = document.createElement('div');
          resultItem.classList.add('result-item', 'success');

          const detailsNode = document.createTextNode(
            data.details.map(d => `${d.message} Quantity: ${d.quantity}`).join('\n')
          );
          resultItem.appendChild(detailsNode);

          const totalNode = document.createElement('div');
          totalNode.className = 'total-quantity';
          totalNode.textContent = `✅ Total Quantity for ${phase.name}: ${data.totalQuantity}`;
          resultItem.appendChild(totalNode);

          resultsDiv.appendChild(resultItem);
        });
      }

      loader.style.display = 'none';
      checkButton.disabled = false;
    });
  });
  </script>
</body>
</html>
